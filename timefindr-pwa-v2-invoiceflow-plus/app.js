
if('serviceWorker' in navigator){addEventListener('load',()=>navigator.serviceWorker.register('./service-worker.js'))}
const $=id=>document.getElementById(id);const state={editingId:null,photos:[]};
const defaults={biz:"TIMEFINDR LLC",email:"ventas@timefindr.com",phone:"+52 55 6318 4206",addr:"169 East Flagler St, Suite 1629, Miami, FL 33131",prefix:"TF",tax:0,cur:"USD",terms:"Propiedad hasta pago total. No hay devoluciones en piezas selladas. Pagos por transferencia.",clabe:"",wire:"",stripe:"",crypto:"",logo:null,supaUrl:"",supaKey:""};
const settings=Object.assign({},defaults,JSON.parse(localStorage.getItem('settings')||'{}'));
function applySettings(){['biz','email','phone','addr','prefix','terms','clabe','wire','stripe','crypto'].forEach(k=>{const el=$('s-'+k);if(el) el.value=settings[k]||''});$('s-tax').value=settings.tax;$('s-cur').value=settings.cur;if(settings.logo){$('brand-logo').src=settings.logo} $('y').textContent=new Date().getFullYear();$('today').textContent=new Date().toLocaleDateString('es-MX');$('btn-sync').style.display=(settings.supaUrl&&settings.supaKey)?'inline-flex':'none'}
applySettings();
function saveSettings(){Object.assign(settings,{biz:$('s-biz').value,email:$('s-email').value,phone:$('s-phone').value,addr:$('s-addr').value,prefix:$('s-prefix').value||'TF',tax:parseFloat($('s-tax').value||0),cur:$('s-cur').value,terms:$('s-terms').value,clabe:$('s-clabe').value,wire:$('s-wire').value,stripe:$('s-stripe').value,crypto:$('s-crypto').value,supaUrl:$('s-supa-url').value,supaKey:$('s-supa-key').value});localStorage.setItem('settings',JSON.stringify(settings));applySettings();alert('Ajustes guardados')}
function handleLogo(e){const f=e.target.files[0];if(!f) return;const r=new FileReader();r.onload=()=>{settings.logo=r.result;localStorage.setItem('settings',JSON.stringify(settings));applySettings()};r.readAsDataURL(f)}
function showTab(t){document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));document.querySelectorAll('main>section').forEach(s=>s.style.display='none');({'inv':['tab-inv','view-inv',renderInv],'new':['tab-new','view-new',null],'fin':['tab-fin','view-rcv',renderRcv],'settings':['tab-settings','view-settings',null]})[t].forEach((v,i)=>{if(i===0)$(v).classList.add('active');else if(i===1)$(v).style.display='block';else if(i===2&&v)v()})}
$('tab-inv').onclick=()=>showTab('inv');$('tab-new').onclick=()=>showTab('new');$('tab-fin').onclick=()=>showTab('fin');$('tab-settings').onclick=()=>showTab('settings');
const listPieces=()=>JSON.parse(localStorage.getItem('pieces')||'[]');function setPieces(v){localStorage.setItem('pieces',JSON.stringify(v))}
function fmt(v,c){try{return new Intl.NumberFormat('es-MX',{style:'currency',currency:c||'USD'}).format(v)}catch(e){return (+v).toFixed(2)}}
function handlePhotos(e){const files=[...e.target.files].slice(0,6);state.photos=[];const max=1200;let done=0;files.forEach(f=>{const img=new Image();const r=new FileReader();r.onload=()=>{img.onload=()=>{const ratio=Math.min(1,max/Math.max(img.width,img.height));const c=document.createElement('canvas');c.width=img.width*ratio;c.height=img.height*ratio;const ctx=c.getContext('2d');ctx.drawImage(img,0,0,c.width,c.height);c.toBlob(b=>{const r2=new FileReader();r2.onload=()=>{state.photos.push(r2.result);done++;if(done===files.length)renderPhotos()};r2.readAsDataURL(b)},'image/jpeg',0.85)};img.src=r.result};r.readAsDataURL(f)})}
function renderPhotos(){const box=$('photos-preview');box.innerHTML='';state.photos.forEach(src=>{const im=new Image();im.src=src;im.className='thumb';box.appendChild(im)})}
function addPartnerRow(p={name:'',share:''}){const d=document.createElement('div');d.className='row';d.innerHTML=`<div><input placeholder="Nombre del socio" value="${p.name||''}"></div><div><input type="number" placeholder="% participación" value="${p.share||''}"></div><div><button class="btn bad" onclick="this.closest('.row').remove()">Quitar</button></div>`;$('partners-list').appendChild(d)}
function resetForm(){state.editingId=null;state.photos=[];renderPhotos();['f-model','f-ref','f-serial','f-year','f-contents','f-fx','f-cost','f-extra','f-tax','f-client','f-client-email'].forEach(id=>$(id).value='');$('f-cond').value='Nuevo sellado';$('f-currency').value=settings.cur||'USD';$('f-credit').value='0';$('partners-list').innerHTML=''}
function savePiece(){const partners=[...$('partners-list').querySelectorAll('.row')].map(r=>{const [n,s]=r.querySelectorAll('input');return {name:n.value,share:parseFloat(s.value||0)}}).filter(p=>p.name);const p={id:state.editingId||crypto.randomUUID(),model:$('f-model').value.trim(),ref:$('f-ref').value.trim(),serial:$('f-serial').value.trim(),year:$('f-year').value?parseInt($('f-year').value):null,cond:$('f-cond').value,contents:$('f-contents').value.trim(),currency:$('f-currency').value,fx:parseFloat($('f-fx').value||0),cost:parseFloat($('f-cost').value||0),extra:parseFloat($('f-extra').value||0),tax:parseFloat($('f-tax').value||0),client:$('f-client').value.trim(),clientEmail:$('f-client-email').value.trim(),creditDays:parseInt($('f-credit').value||0),partners,photos:state.photos||[],sell:null,discount:0,shipping:0,createdAt:new Date().toISOString(),invoices:[]};if(!p.model){alert('Modelo es requerido');return}const items=listPieces();const i=items.findIndex(x=>x.id===p.id);if(i>=0)items[i]=p;else items.push(p);setPieces(items);alert('Pieza guardada');resetForm();showTab('inv')}
function editPiece(id){const p=listPieces().find(x=>x.id===id);if(!p) return;state.editingId=p.id;['model','ref','serial','year','cond','contents','currency','fx','cost','extra','tax','client','clientEmail','creditDays'].forEach(k=>{const el=$('f-'+(k==='clientEmail'?'client-email':k==='creditDays'?'credit':k));if(el) el.value=p[k]??''});$('partners-list').innerHTML='';(p.partners||[]).forEach(addPartnerRow);state.photos=p.photos||[];renderPhotos();showTab('new')}
function delPiece(id){if(!confirm('¿Eliminar esta pieza?'))return;setPieces(listPieces().filter(i=>i.id!==id));renderInv()}
function calcCOGS(p){return (+p.cost||0)+(+p.extra||0)}
function renderInv(){const q=$('q').value.toLowerCase();const tb=$('inv-table').querySelector('tbody');tb.innerHTML='';let totSell=0,totCOGS=0,totGross=0;listPieces().filter(p=>!q||[p.model,p.ref,p.serial].join(' ').toLowerCase().includes(q)).forEach(p=>{const cogs=calcCOGS(p);const price=(p.sell!=null)?(+p.sell):null;const gross=(price!=null)?(price - cogs):null;if(price!=null){totSell+=price;totCOGS+=cogs;totGross+=gross}const tr=document.createElement('tr');const credit=p.creditDays>0?(p.creditDays+' días'):'Contado';tr.innerHTML=`<td>${p.model}</td><td>${p.ref||''}</td><td>${p.serial||''}</td><td>${p.year||''}</td><td>${p.cond||''}</td><td>${p.currency}</td><td class="right">${price!=null?fmt(price,p.currency):'—'}</td><td class="right">${fmt(cogs,p.currency)}</td><td class="right">${price!=null?fmt(gross,p.currency):'—'}</td><td><span class="badge">${credit}</span></td><td class="right"><button class="btn secondary" onclick="editPiece('${p.id}')">Editar</button> <button class="btn" onclick="createInvoice('${p.id}')">Invoice</button> <button class="btn bad" onclick="delPiece('${p.id}')">Borrar</button></td>`;tb.appendChild(tr)});$('tot-sell').textContent=fmt(totSell,settings.cur||'USD');$('tot-cogs').textContent=fmt(totCOGS,settings.cur||'USD');$('tot-gross').textContent=fmt(totGross,settings.cur||'USD');$('sum-sell').textContent=$('tot-sell').textContent;$('sum-cogs').textContent=$('tot-cogs').textContent;$('sum-gross').textContent=$('tot-gross').textContent;const pct=totSell?((totGross/totSell)*100).toFixed(1)+'%':'';$('sum-gross-pct').textContent=pct}
$('q').addEventListener('input',renderInv)
function exportCSV(){const items=listPieces();const cols=['model','ref','serial','year','cond','contents','currency','sell','discount','shipping','fx','cost','extra','tax','client','clientEmail','creditDays'];const header=cols.join(',');const rows=items.map(p=>cols.map(k=>JSON.stringify(p[k]??'')).join(','));const csv=[header,...rows].join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='timefindr_inventario.csv';a.click();URL.revokeObjectURL(url)}
function backupJSON(){const data={settings, pieces:listPieces()};const blob=new Blob([JSON.stringify(data)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='timefindr_backup.json';a.click();URL.revokeObjectURL(url)}
function restoreJSON(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const data=JSON.parse(r.result);if(data.settings)localStorage.setItem('settings',JSON.stringify(data.settings));if(data.pieces)localStorage.setItem('pieces',JSON.stringify(data.pieces));location.reload()}catch(err){alert('Archivo inválido')}};r.readAsText(f)}
async function scanBarcode(targetId){try{if(!('BarcodeDetector' in window)){alert('BarcodeDetector no soportado');return}const det=new BarcodeDetector({formats:['qr_code','code_128','ean_13','ean_8','upc_e','upc_a']});const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});const v=document.createElement('video');v.srcObject=s;v.setAttribute('playsinline','');await v.play();const c=document.createElement('canvas');const ctx=c.getContext('2d');let done=false;const overlay=document.createElement('div');overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999';const stop=document.createElement('button');stop.className='btn bad';stop.textContent='Cancelar';stop.onclick=()=>{s.getTracks().forEach(t=>t.stop());overlay.remove()};overlay.appendChild(stop);document.body.appendChild(overlay);(async function loop(){if(v.readyState===v.HAVE_ENOUGH_DATA){c.width=v.videoWidth;c.height=v.videoHeight;ctx.drawImage(v,0,0,c.width,c.height);const bmp=await createImageBitmap(c);const codes=await det.detect(bmp);if(codes&&codes[0]){$(targetId).value=codes[0].rawValue;s.getTracks().forEach(t=>t.stop());overlay.remove();return}}requestAnimationFrame(loop)})()}catch(e){alert('No se pudo usar la cámara')}}
function daysFromNow(n){const d=new Date();d.setDate(d.getDate()+n);return d}
function createInvoice(id){const items=listPieces();const p=items.find(x=>x.id===id);if(!p){alert('No encontrada');return}
  // Ask for price/tax/fx/discount/shipping at invoice time
  const price=parseFloat(prompt('Precio de venta ('+(p.currency||'USD')+'):','')||'0');if(!price){alert('Precio requerido');return}
  const tax= parseFloat(prompt('Impuesto % (ej. 16):', (isFinite(p.tax)?p.tax:0))||'0');
  let fx = p.fx||0; if((p.currency||'USD')!=='USD'){ fx = parseFloat(prompt('Tipo de cambio (si aplica):', fx||'')||'0'); }
  const discount = parseFloat(prompt('Descuento (mismo tipo de moneda):','0')||'0');
  const shipping = parseFloat(prompt('Gastos de envío (mismo tipo de moneda):','0')||'0');
  // Persist these in the piece so summaries reflect them
  p.sell = price; p.tax = tax; p.fx = fx; p.discount = discount; p.shipping = shipping;
  // Compute invoice totals
  const pretax = Math.max(0, price - discount + shipping);
  const taxAmt = pretax * (tax/100);
  const total = pretax + taxAmt;
  const baseCost=(+p.cost||0)+(+p.extra||0);
  const profit = Math.max(0, price - baseCost);
  const partners=(p.partners||[]).map(pt=>{const s=(+pt.share||0)/100;const contrib=baseCost*s;const profitShare=profit*s;return {...pt,contrib,profitShare,payout:contrib+profitShare}});
  const seqKey='inv-seq-'+new Date().getFullYear();const seq=+localStorage.getItem(seqKey)||0;localStorage.setItem(seqKey,String(seq+1));
  const folio=`${settings.prefix}-${new Date().getFullYear()}-${String(seq+1).padStart(4,'0')}`;
  const issued=new Date();const due=p.creditDays>0?daysFromNow(p.creditDays):issued;
  const inv={id:crypto.randomUUID(),folio,issued:issued.toISOString(),due:due.toISOString(),currency:p.currency,fx:fx||null,client:p.client||'',clientEmail:p.clientEmail||'',partners,payments:[],line:{price,discount,shipping,taxPct:tax,pretax,taxAmt,total}};
  p.invoices=p.invoices||[];p.invoices.push(inv);setPieces(items);
  openInvoice(p.id,inv.id);
  renderInv();
}
function openInvoice(pid,iid){const url=new URL(location.href);const u=url.origin+url.pathname+'#/invoice/'+pid+'/'+iid;const w=window.open(u,'_blank');if(!w){location.hash='#/invoice/'+pid+'/'+iid}else{w.focus()}}
function renderRcv(){const tb=$('rcv-table').querySelector('tbody');tb.innerHTML='';listPieces().forEach(p=>(p.invoices||[]).forEach(inv=>{const due=new Date(inv.due),issued=new Date(inv.issued);const paid=(inv.payments||[]).reduce((a,c)=>a+Number(c.amount||0),0);const bal=Math.max(0,(inv.line?.total||0)-paid);const late=(new Date()>due)&&bal>0;const tr=document.createElement('tr');tr.innerHTML=`<td>${inv.folio}</td><td>${inv.client||'-'}</td><td>${p.model} ${p.ref?('('+p.ref+')'):''}</td><td>${issued.toLocaleDateString('es-MX')}</td><td>${due.toLocaleDateString('es-MX')} ${late?'<span class="badge">Vencida</span>':''}</td><td class="right">${fmt(bal,inv.currency||'USD')}</td><td class="right"><button class="btn secondary" onclick="openInvoice('${p.id}','${inv.id}')">Ver</button></td>`;tb.appendChild(tr)}))}
addEventListener('hashchange',route);addEventListener('load',route);function route(){if(location.hash.startsWith('#/invoice/')){const [, , pid, iid]=location.hash.split('/');renderInvoiceView(pid,iid)}}
function recordPayment(pid,iid){const items=listPieces();const p=items.find(x=>x.id===pid);if(!p) return;const inv=(p.invoices||[]).find(i=>i.id===iid);if(!inv) return;const amount=parseFloat(prompt('Monto del pago:',inv.line?.total||0)||'0');if(!amount)return;const currency=prompt('Moneda del pago (USD/MXN):',inv.currency||'USD')||inv.currency||'USD';const fx=parseFloat(prompt('Tipo de cambio de este pago (si aplica):',inv.fx||'0')||'0');inv.payments=inv.payments||[];inv.payments.push({id:crypto.randomUUID(),date:new Date().toISOString(),amount,currency,fx:fx||null});setPieces(items);renderInvoiceView(pid,iid,true)}
function computeFX(inv){const base=inv.currency||'USD';const invFx=+inv.fx||null;let realized=0;(inv.payments||[]).forEach(p=>{if(p.currency&&p.currency!==base&&p.fx&&invFx){const atInv=Number(p.amount)/invFx;const atPay=Number(p.amount)/Number(p.fx);realized+=(atPay - atInv)}});return realized}
function renderInvoiceView(pid,iid){const p=listPieces().find(x=>x.id===pid);if(!p){alert('No encontrada');return}const inv=(p.invoices||[]).find(i=>i.id===iid);if(!inv){alert('Invoice no encontrada');return}const line=inv.line||{};const paid=(inv.payments||[]).reduce((a,c)=>a+Number(c.amount||0),0);const bal=Math.max(0,(line.total||0)-paid);const fxGain=computeFX(inv);const photos=(p.photos||[]).slice(0,4).map(s=>`<img src="${s}" style="width:100px;height:100px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;margin-right:6px">`).join('');const seller=JSON.parse(localStorage.getItem('settings')||'{}');const pays=(inv.payments||[]).map(pm=>`<tr><td>Pago ${new Date(pm.date).toLocaleDateString('es-MX')} (${pm.currency}${pm.fx?(' · FX '+pm.fx):''})</td><td class="right">${fmt(pm.amount,pm.currency)}</td></tr>`).join('');const html=`<!doctype html><html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Invoice ${inv.folio}</title><style>body{font-family:-apple-system,system-ui,Inter,Arial;margin:0;color:#111}.wrap{max-width:860px;margin:0 auto;padding:24px}table{width:100%;border-collapse:collapse;margin-top:10px}th,td{padding:10px 8px;border-bottom:1px solid #e5e7eb;text-align:left}.right{text-align:right}@media print{.no-print{display:none}}</style></head><body><div class="wrap"><div style="display:flex;justify-content:space-between;gap:12px"><div><h1>Invoice</h1><div style="color:#6b7280">${inv.folio}</div></div><div style="text-align:right"><div><strong>${seller.biz||'TIMEFINDR LLC'}</strong></div><div style="color:#6b7280">${seller.addr||''}</div><div style="color:#6b7280">${seller.email||''} · ${seller.phone||''}</div></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px"><div><h3>Facturar a</h3><div><strong>${inv.client||'-'}</strong></div><div style="color:#6b7280">${p.clientEmail||''}</div></div><div><h3>Fechas</h3><div>Emisión: <strong>${new Date(inv.issued).toLocaleDateString('es-MX')}</strong></div><div>Vencimiento: <strong>${new Date(inv.due).toLocaleDateString('es-MX')}</strong></div></div></div><div style="margin-top:10px">${photos}</div><table><thead><tr><th>Descripción</th><th class="right">Importe</th></tr></thead><tbody><tr><td>${p.model} ${p.ref?('('+p.ref+')'):''} · Serie: ${p.serial||'-'} · Año: ${p.year||'-'} · Condición: ${p.cond||'-'} · Contenido: ${p.contents||'-'}</td><td class="right">${fmt(line.price,inv.currency)}</td></tr>${(line.discount||0)>0?`<tr><td class="right">Descuento</td><td class="right">− ${fmt(line.discount,inv.currency)}</td></tr>`:''}${(line.shipping||0)>0?`<tr><td class="right">Envío</td><td class="right">${fmt(line.shipping,inv.currency)}</td></tr>`:''}<tr><td class="right"><strong>Subtotal</strong></td><td class="right">${fmt(line.pretax,inv.currency)}</td></tr><tr><td class="right"><strong>Impuesto (${line.taxPct||0}%)</strong></td><td class="right">${fmt(line.taxAmt,inv.currency)}</td></tr><tr><td class="right"><strong>Total</strong></td><td class="right"><strong>${fmt(line.total,inv.currency)}</strong></td></tr>${pays}${pays?`<tr><td class="right"><strong>Saldo</strong></td><td class="right"><strong>${fmt(bal,inv.currency)}</strong></td></tr>`:''}</tbody></table>${inv.fx?`<div style="color:#6b7280;margin-top:6px">Tipo de cambio (emisión): ${inv.fx}</div>`:''}${(inv.fx && (inv.payments||[]).length)?`<div style="color:#6b7280">Ganancia/pérdida cambiaria aprox: ${fxGain.toFixed(2)} ${inv.currency}</div>`:''}<div style="margin-top:12px"><h3>Pagos</h3><div>CLABE MX: ${seller.clabe||'-'}</div><div>Wire US: ${seller.wire||'-'}</div><div>Tarjeta: ${seller.stripe?('<a href="'+seller.stripe+'">'+seller.stripe+'</a>'):'-'}</div><div>Crypto: ${seller.crypto||'-'}</div></div><div style="color:#6b7280;margin-top:12px">Términos: ${seller.terms||''}</div><div class="no-print" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap"><button onclick="print()">Imprimir / Guardar PDF</button><button onclick="opener&&opener.recordPayment&&opener.recordPayment('${pid}','${iid}')">Registrar pago</button><button onclick="close()">Cerrar</button></div></div></body></html>`;const w=window.open('','_blank');w.document.write(html);w.document.close()}
function syncCloud(){if(!(settings.supaUrl&&settings.supaKey)){alert('Configura SUPABASE URL/KEY en Ajustes');return}alert('Demo: enviaríamos JSON a Supabase (requiere tablas y reglas).')}
function renderInvInit(){showTab('inv');renderInv()}renderInvInit();
